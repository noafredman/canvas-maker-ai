<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Selection Test</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .controls button {
            margin: 5px;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        .canvas-wrapper {
            width: 100%;
            height: 600px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Nested Canvas Overlay Styles - copied from styles.css to fix dimension issues */
        .nested-canvas-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nested-canvas-overlay.show {
            opacity: 1;
            transform: scale(1);
        }

        .nested-canvas-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            margin: 50px;
            width: 800px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .nested-canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
        }

        .nested-canvas-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .nested-canvas-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: white;
            min-height: 0; /* Important for flex items to shrink properly */
        }

        #nested-canvas {
            display: block;
            background: white;
            cursor: crosshair;
            touch-action: none;
            border: 5px solid red !important; /* Make it super obvious if it exists */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Line and Arrow Selection Test</h1>
        <p>Testing hover and click selection for lines and arrows</p>
        
        <div class="controls">
            <button onclick="addLine()">Add Line</button>
            <button onclick="addArrow()">Add Arrow</button>
            <button onclick="addRectangle()">Add Rectangle</button>
            <button onclick="addNestedCanvas()">Add Nested Canvas</button>
            <button onclick="clearAll()">Clear All</button>
            <button onclick="selectTool()">Select Tool</button>
            <button onclick="showInfo()">Show Canvas Info</button>
        </div>
        
        <div class="canvas-wrapper" id="canvas-container"></div>
        
        <div class="log" id="log">
            <div><strong>Log:</strong></div>
        </div>
    </div>

    <!-- Add nested canvas overlay for testing -->
    <div id="nested-canvas-overlay" class="nested-canvas-overlay" style="display: none;">
        <div class="nested-canvas-container">
            <div class="nested-canvas-header">
                <span class="nested-canvas-title">Nested Canvas</span>
                <button id="close-nested-canvas" class="close-btn">&times;</button>
            </div>
            <div class="nested-canvas-content">
                <canvas id="nested-canvas" width="800" height="600"></canvas>
                <div id="nested-selection-box" class="selection-box"></div>
            </div>
        </div>
    </div>

    <script src="canvas.js"></script>
    <script>
        let canvasMaker;
        let shapeCount = 0;
        
        // Initialize CanvasMaker
        function initializeCanvas() {
            const container = document.getElementById('canvas-container');
            canvasMaker = new CanvasMaker(container, {
                width: 1000,
                height: 600,
                createToolbar: true
            });
            
            log('CanvasMaker initialized');
            
            // Listen for canvas events
            canvasMaker.canvas.addEventListener('mousemove', (e) => {
                const rect = canvasMaker.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const worldPos = canvasMaker.canvasToWorld(x, y);
                const hovered = canvasMaker.hoveredElement;
                
                if (hovered) {
                    const status = `Hovering: ${hovered.type} at index ${hovered.index}`;
                    updateStatus(status);
                } else {
                    updateStatus(`Mouse at canvas(${x.toFixed(0)}, ${y.toFixed(0)}) world(${worldPos.x.toFixed(0)}, ${worldPos.y.toFixed(0)})`);
                }
            });
        }
        
        function updateStatus(text) {
            const status = document.getElementById('status');
            if (!status) {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'status';
                statusDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 12px;';
                document.body.appendChild(statusDiv);
            }
            document.getElementById('status').textContent = text;
        }
        
        // Add a line
        function addLine() {
            shapeCount++;
            const x1 = 100 + Math.random() * 300;
            const y1 = 100 + Math.random() * 200;
            const x2 = x1 + 50 + Math.random() * 150;
            const y2 = y1 + 50 + Math.random() * 100;
            
            canvasMaker.shapes.push({
                type: 'line',
                x1: x1,
                y1: y1,
                x2: x2,
                y2: y2,
                strokeColor: '#333333',
                lineWidth: 2
            });
            
            canvasMaker.redrawCanvas();
            log(`Added line #${shapeCount} from (${x1.toFixed(0)}, ${y1.toFixed(0)}) to (${x2.toFixed(0)}, ${y2.toFixed(0)})`);
        }
        
        // Add an arrow
        function addArrow() {
            shapeCount++;
            const x1 = 100 + Math.random() * 300;
            const y1 = 100 + Math.random() * 200;
            const x2 = x1 + 50 + Math.random() * 150;
            const y2 = y1 + 50 + Math.random() * 100;
            
            canvasMaker.shapes.push({
                type: 'arrow',
                x1: x1,
                y1: y1,
                x2: x2,
                y2: y2,
                strokeColor: '#333333',
                lineWidth: 2,
                arrowSize: 10
            });
            
            canvasMaker.redrawCanvas();
            log(`Added arrow #${shapeCount} from (${x1.toFixed(0)}, ${y1.toFixed(0)}) to (${x2.toFixed(0)}, ${y2.toFixed(0)})`);
        }
        
        // Add a rectangle for comparison
        function addRectangle() {
            shapeCount++;
            const x = 100 + Math.random() * 300;
            const y = 100 + Math.random() * 200;
            const width = 50 + Math.random() * 100;
            const height = 50 + Math.random() * 100;
            
            canvasMaker.shapes.push({
                type: 'rectangle',
                x: x,
                y: y,
                width: width,
                height: height,
                fill: '#f0f0f0',
                strokeColor: '#333333'
            });
            
            canvasMaker.redrawCanvas();
            log(`Added rectangle #${shapeCount} at (${x.toFixed(0)}, ${y.toFixed(0)}) size ${width.toFixed(0)}x${height.toFixed(0)}`);
        }
        
        // Add a nested canvas for testing
        function addNestedCanvas() {
            shapeCount++;
            const x = 100 + Math.random() * 200;
            const y = 100 + Math.random() * 150;
            const width = 150;
            const height = 100;
            
            const nestedCanvasId = 'nested_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const nestedCanvasShape = {
                type: 'nested-canvas',
                id: nestedCanvasId,
                x: x,
                y: y,
                width: width,
                height: height
            };
            
            canvasMaker.nestedCanvases.push(nestedCanvasShape);
            
            // Initialize empty data for this nested canvas
            canvasMaker.nestedCanvasData.set(nestedCanvasId, {
                paths: [],
                shapes: [],
                texts: [],
                camera: { x: 0, y: 0, zoom: 1 }
            });
            
            canvasMaker.redrawCanvas();
            log(`Added nested canvas #${shapeCount} at (${x.toFixed(0)}, ${y.toFixed(0)}) size ${width}x${height} - Double-click to open!`);
        }
        
        // Clear all shapes
        function clearAll() {
            canvasMaker.shapes = [];
            canvasMaker.selectedElements = [];
            canvasMaker.redrawCanvas();
            shapeCount = 0;
            log('Cleared all shapes');
        }
        
        // Activate select tool
        function selectTool() {
            canvasMaker.currentTool = 'select';
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            const selectBtn = document.getElementById('select-tool');
            if (selectBtn) selectBtn.classList.add('active');
            log('Activated select tool');
        }
        
        // Show canvas info
        function showInfo() {
            const info = {
                shapes: canvasMaker.shapes.length,
                selected: canvasMaker.selectedElements.length,
                hovered: canvasMaker.hoveredElement ? `${canvasMaker.hoveredElement.type} at index ${canvasMaker.hoveredElement.index}` : 'none',
                currentTool: canvasMaker.currentTool,
                camera: `x: ${canvasMaker.camera.x.toFixed(1)}, y: ${canvasMaker.camera.y.toFixed(1)}, zoom: ${canvasMaker.camera.zoom.toFixed(2)}`
            };
            log('Canvas info: ' + JSON.stringify(info, null, 2));
        }
        
        // Logging function
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">${time}:</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[LINE-TEST] ${message}`);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            
            // Add some initial shapes
            setTimeout(() => {
                addLine();
                addArrow();
                addRectangle();
                selectTool();
            }, 500);
        });
    </script>
</body>
</html>